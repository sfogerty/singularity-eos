<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contributing &mdash; Singularity-EOS  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Use Sphinx for Writing Docs" href="sphinx-doc.html" />
    <link rel="prev" title="Mixed Cell Closures" href="using-closures.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Singularity-EOS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building Singularity-EOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-eos.html">The Equation of State API</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">EOS Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-closures.html">Mixed Cell Closures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#useful-code-structure-information">Useful code structure information</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-variant-class-and-mpark-variant">The <code class="docutils literal notranslate"><span class="pre">Variant</span></code> class and <code class="docutils literal notranslate"><span class="pre">mpark::variant</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-crtp-slass-structure-and-static-polymorphism">The CRTP slass structure and static polymorphism</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sphinx-doc.html">How to Use Sphinx for Writing Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Singularity-EOS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Contributing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/src/contributing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="contributing">
<span id="contributing-doc"></span><h1>Contributing<a class="headerlink" href="#contributing" title="Permalink to this headline"></a></h1>
<section id="useful-code-structure-information">
<h2>Useful code structure information<a class="headerlink" href="#useful-code-structure-information" title="Permalink to this headline"></a></h2>
<section id="the-variant-class-and-mpark-variant">
<h3>The <code class="docutils literal notranslate"><span class="pre">Variant</span></code> class and <code class="docutils literal notranslate"><span class="pre">mpark::variant</span></code><a class="headerlink" href="#the-variant-class-and-mpark-variant" title="Permalink to this headline"></a></h3>
<p>Work in progress. Things to cover:</p>
<ul class="simple">
<li><p>Type erasure</p></li>
<li><p>Unified API</p></li>
</ul>
</section>
<section id="the-crtp-slass-structure-and-static-polymorphism">
<h3>The CRTP slass structure and static polymorphism<a class="headerlink" href="#the-crtp-slass-structure-and-static-polymorphism" title="Permalink to this headline"></a></h3>
<p>Each of the EOS models in <code class="docutils literal notranslate"><span class="pre">singularity-eos</span></code> inherits from a base class in
order to centralize default functionality and avoid code duplication. The two
main examples of this are the vector overloads and the <code class="docutils literal notranslate"><span class="pre">PTofRE</span></code> scalar lookup
function. In the vector overloads, a simple for loop is used to loop over the
set of states provided to the function and then call the scalar version on each
state. The <code class="docutils literal notranslate"><span class="pre">PTofRE</span></code> function is designed to provide a common method for
getting the needing information for a PTE solve from an EOS. Both of these
features are not dependent on the specific EOS for their definition, but in the
case of the vector overloads, they <em>do</em> need to access methods in the derived
class.</p>
<p>The vector overloads in the base class take the following form (in pseudocode):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">RealIndexer</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ConstRealIndexer</span><span class="p">,</span> <span class="k">typename</span> <span class="n">LambdaIndexer</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">TemperatureFromDensityInternalEnergy</span><span class="p">(</span><span class="n">ConstRealIndexer</span> <span class="o">&amp;&amp;</span><span class="n">rhos</span><span class="p">,</span> <span class="n">ConstRealIndexer</span> <span class="o">&amp;&amp;</span><span class="n">sies</span><span class="p">,</span>
                                     <span class="n">RealIndexer</span> <span class="o">&amp;&amp;</span><span class="n">temperatures</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
                                     <span class="n">LambdaIndexer</span> <span class="o">&amp;&amp;</span><span class="n">lambdas</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">temperatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="p">.</span><span class="n">TemperatureFromDensityInternalEnergy</span><span class="p">(</span><span class="n">rhos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">sies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
<p>where the base class basically needs to call the implementation of the scalar
lookup in the specific EOS. However, this means that the base class needs to
have knowledge of which class is being derived from it in order to call the
correct EOS implementation.</p>
<p>The challenge in making this sort of code performance portable is that on a CPU
this sort of type deduction (i.e. what specific EOS implementaiton to call)
would be done at runtime through vtables. In a heterogenous computing enviroment
though, the vtable may point to member functions that do not exist on the
device, causing a segfault. We could have used a similar technique to the
modifier classes and pass the EOS as a template paramter, but then the vector
function calls could only be achieved by creating vector modifiers of all the
implemented EOS.</p>
<p>Instead, the strategy we decided to use in this case was to implement the
polymorphism at compile time through the <a class="reference external" href="https://www.fluentcpp.com/2017/05/12/curiously-recurring-template-pattern/">CRTP</a> (curiously recurisve templating
pattern). The basic idea is two-fold:</p>
<ol class="arabic simple">
<li><p>The base class is templated on the derived class to avoid the need for
vtables.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">*this</span></code> pointer for the base class can be statically cast to that of
the derived class since the derived class inherits from the base. This is
only possible because the base class is inherited by the derived class and
this is known at compile time.</p></li>
</ol>
<p>Through template resolution, the compiler can then know exactly which member
functions need to be called at <em>compile time</em>. This allows us to write the EOS
implementation in the derived class and have the base class call the appropriate
member function.</p>
<p>The above example modified to take advantage of the CRTP becomes</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">CRTP</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">EosBase</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">RealIndexer</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ConstRealIndexer</span><span class="p">,</span> <span class="k">typename</span> <span class="n">LambdaIndexer</span><span class="o">&gt;</span>
  <span class="kr">inline</span> <span class="kt">void</span>
  <span class="n">TemperatureFromDensityInternalEnergy</span><span class="p">(</span><span class="n">ConstRealIndexer</span> <span class="o">&amp;&amp;</span><span class="n">rhos</span><span class="p">,</span> <span class="n">ConstRealIndexer</span> <span class="o">&amp;&amp;</span><span class="n">sies</span><span class="p">,</span>
                                       <span class="n">RealIndexer</span> <span class="o">&amp;&amp;</span><span class="n">temperatures</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
                                       <span class="n">LambdaIndexer</span> <span class="o">&amp;&amp;</span><span class="n">lambdas</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">temperatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">CRTP</span> <span class="k">const</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">TemperatureFromDensityInternalEnergy</span><span class="p">(</span>
        <span class="n">rhos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">EosBase</span></code> class is templated upon the derived class which is passed via the
<cite>CRTP</cite> template parameter. Then the <code class="docutils literal notranslate"><span class="pre">EosBase</span></code> class vector implementation
statically casts its own <code class="docutils literal notranslate"><span class="pre">*this</span></code> pointer to that of the derived class in order
to call the specific EOS implementation.</p>
<p>The derived class then needs to look something like</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EosImplementation</span> <span class="o">:</span> <span class="k">public</span> <span class="n">EosBase</span><span class="o">&lt;</span><span class="n">EosImplementation</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="kr">inline</span> <span class="n">Real</span> <span class="n">TemperatureFromDensityInternalEnergy</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">Real</span> <span class="n">rho</span><span class="p">,</span> <span class="k">const</span> <span class="n">Real</span> <span class="n">sie</span><span class="p">,</span> <span class="n">Real</span> <span class="o">*</span><span class="n">lambda</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// Specific EOS implementation for returning T(rho, e)</span>
    <span class="k">return</span> <span class="n">temperature</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">using</span> <span class="n">EosBase</span><span class="o">&lt;</span><span class="n">EosImplementation</span><span class="o">&gt;::</span><span class="n">TemperatureFromDensityInternalEnergy</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">using</span></code> statement needs to be included in order to properly
overload the scalar functionality with the vector functionality. Otherwise the
vector member function is hidden by the derived class method rather than
overloaded.</p>
<p>With several EOS that all inherit from the <code class="docutils literal notranslate"><span class="pre">EosBase</span></code> class, we can achieve
static polymorphism in all of the EOS classes without having to implement
vector member functions in each class.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="using-closures.html" class="btn btn-neutral float-left" title="Mixed Cell Closures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sphinx-doc.html" class="btn btn-neutral float-right" title="How to Use Sphinx for Writing Docs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2022. Triad National Security.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: jhp_developer_doc
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../brryan/stellarcollapse_T_units/src/contributing.html">brryan/stellarcollapse_T_units</a></dd>
      <dd><a href="../../dholladay00/sap_ramp/src/contributing.html">dholladay00/sap_ramp</a></dd>
      <dd><a href="../../jdolence/new_pte/src/contributing.html">jdolence/new_pte</a></dd>
      <dd><a href="contributing.html">jhp_developer_doc</a></dd>
      <dd><a href="../../jhp_eos_vector/src/contributing.html">jhp_eos_vector</a></dd>
      <dd><a href="../../jhp_gruneisen/src/contributing.html">jhp_gruneisen</a></dd>
      <dd><a href="../../jmm/doc-fill/src/contributing.html">jmm/doc-fill</a></dd>
      <dd><a href="../../jmm/profile-root/src/contributing.html">jmm/profile-root</a></dd>
      <dd><a href="../../jmm/sesame2spiner-library/src/contributing.html">jmm/sesame2spiner-library</a></dd>
      <dd><a href="../../main/src/contributing.html">main</a></dd>
      <dd><a href="../../mauneyc/feature/singular-spackage/src/contributing.html">mauneyc/feature/singular-spackage</a></dd>
      <dd><a href="../../mauneyc/fix/spack_info_homepage/src/contributing.html">mauneyc/fix/spack_info_homepage</a></dd>
      <dd><a href="../../mauneyc/fix/spackdown/src/contributing.html">mauneyc/fix/spackdown</a></dd>
      <dd><a href="../../mauneyc/update/cmake-idiomatic-install/src/contributing.html">mauneyc/update/cmake-idiomatic-install</a></dd>
      <dd><a href="../../rberger/python_interface/src/contributing.html">rberger/python_interface</a></dd>
      <dd><a href="../../sap_integration/src/contributing.html">sap_integration</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>